# Reverse proxy with oauth2-proxy (Keycloak) auth gate in front of welcome + role apps.
# Ports only bound to loopback via docker-compose to keep private on VPS.

user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  keepalive_timeout  65;
  server_tokens off;

  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  upstream welcome_app { server welcome-frontend:9000; }
  upstream regulator_app { server regulator-frontend:9000; }
  upstream auditor_app { server auditor-frontend:9000; }
  upstream farmer_app { server farmer-frontend:9000; }
  upstream retail_app { server retail-frontend:9000; }
  upstream laboratory_app { server laboratory-frontend:9000; }

  # Helper for redirect to login
  map $request_uri $auth_login_url {
    default "/oauth2/start?rd=$scheme://$host$request_uri";
  }

  server {
    listen 80;
    # All regular paths require auth except explicit oauth2 endpoints
    auth_request /oauth2/auth;
    error_page 401 = @oauth2_login;

    # OAuth2 Proxy endpoints (bypass auth_request to avoid loops)
    # IMPORTANT: Trailing slash in proxy_pass would strip the /oauth2/ prefix
    # and turn /oauth2/auth into /auth upstream (causing 403 instead of 401/202).
    # Keep proxy_pass WITHOUT trailing slash so paths are preserved.
    location /oauth2/ {
      proxy_pass http://oauth2-proxy:4180;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Scheme $scheme;
      proxy_set_header X-Auth-Request-Redirect $request_uri;
    }

    location @oauth2_login {
      return 302 /oauth2/start?rd=$scheme://$host$request_uri;
    }

    # Root welcome (after auth)
    location = / {
      proxy_pass http://welcome_app;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Role-specific mounts
  location /regulator/ {
    proxy_pass http://regulator_app/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location /auditor/ {
    proxy_pass http://auditor_app/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location /farmer/ {
    proxy_pass http://farmer_app/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location /retail/ {
    proxy_pass http://retail_app/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  location /laboratory/ {
    proxy_pass http://laboratory_app/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

    # Vite HMR websockets (optional, may adjust ports)
    location /hmr-regulator/ { proxy_pass http://regulator_app; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; }
  }
}
